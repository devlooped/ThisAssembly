 <Project>
  <!--
  ILRepack.targets provides MSBuild integration for ILRepack, allowing merging of assemblies into a single output.

  Extension Points:
  - Property 'ILRepack': Set to 'true' to enable ILRepack (default: true in Release, false otherwise).
  - Items:
      * ILRepackInclude: assemblies to include 
      * ILRepackExclude: assemblies to exclude
      * ILRepackPreserve: assemblies to preserve after merging (otherwise, they are deleted from output)
  
  Items can have metadata 'StartsWith' set to 'true' to indicate prefix matching rather than 
  exact matching.
  -->

  <PropertyGroup>
    <ILRepack Condition="'$(ILRepack)' == '' and '$(Configuration)' == 'Release'">true</ILRepack>
    <ILRepack Condition="'$(ILRepack)' == ''">false</ILRepack>
    <!-- We need to turn on copy-local for ILRepack to find deps -->
    <CopyLocalLockFileAssemblies Condition="'$(CopyLocalLockFileAssemblies)' == '' and '$(ILRepack)' == 'true'">true</CopyLocalLockFileAssemblies>
  </PropertyGroup>

  <Target Name="EnsureILRepack" BeforeTargets="ILRepack" Condition="'$(ILRepack)' == 'true'">
    <Exec Command="ilrepack --version" StandardErrorImportance="high" StandardOutputImportance="low" ConsoleToMSBuild="true" IgnoreExitCode="true" ContinueOnError="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="ILRepackOutput" />
      <Output TaskParameter="ExitCode" PropertyName="ExitCode" />
    </Exec>
    <Message Importance="high" Text="Using installed dotnet-ilrepack v$(ILRepackOutput)" Condition="$(ExitCode) == '0'" />
    <Exec Command="dotnet tool install -g dotnet-ilrepack"
          Condition="$(ExitCode) != '0'" />
    <Exec Command="ilrepack --version" Condition="$(ExitCode) != '0'" ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="ILRepackInstalledOutput" />
    </Exec>
    <Message Importance="high" Text="Installed dotnet-ilrepack v$(ILRepackInstalledOutput)" Condition="$(ExitCode) != '0'" />
  </Target>

  <Target Name="ILRepackPrepare">
    <ItemGroup>
      <ILRepackIncludeWildcard Include="@(ILRepackInclude -> WithMetadataValue('StartsWith', 'true'))"/>
      <ILRepackIncludeExact Include="@(ILRepackInclude)" Exclude="@(ILRepackIncludeWildcard)" />
      <ILRepackExcludeWildcard Include="@(ILRepackExclude -> WithMetadataValue('StartsWith', 'true'))" />
      <ILRepackExcludeExact Include="@(ILRepackExclude)" Exclude="@(ILRepackExcludeWildcard)" />
      <ILRepackPreserveWildcard Include="@(ILRepackPreserve -> WithMetadataValue('StartsWith', 'true'))"/>
      <ILRepackPreserveExact Include="@(ILRepackPreserve)" Exclude="@(ILRepackPreserveWildcard)" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackFilterIncludeStartsWith" DependsOnTargets="ILRepackPrepare;CoreCompile"
          Inputs="@(ILRepackIncludeWildcard)" Outputs="|%(ILRepackIncludeWildcard.Identity)|">
    <PropertyGroup>
      <LocalFilter>%(ILRepackIncludeWildcard.Identity)</LocalFilter>
    </PropertyGroup>
    <ItemGroup>
      <ILRepackCandidate Include="@(ReferenceCopyLocalPaths)" Condition="
        '%(Extension)' == '.dll' And 
        !$([MSBuild]::ValueOrDefault('%(FileName)', '').EndsWith('.resources', StringComparison.OrdinalIgnoreCase)) And
        $([MSBuild]::ValueOrDefault('%(FileName)', '').StartsWith('$(LocalFilter)'))" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackFilterExcludeStartsWith" DependsOnTargets="ILRepackFilterIncludeStartsWith"
          Inputs="@(ILRepackExcludeWildcard)" Outputs="|%(ILRepackExcludeWildcard.Identity)|">
    <PropertyGroup>
      <LocalFilter>%(ILRepackExcludeWildcard.Identity)</LocalFilter>
    </PropertyGroup>
    <ItemGroup>
      <ILRepackCandidate Remove="@(ILRepackCandidate)" Condition="
        $([MSBuild]::ValueOrDefault('%(FileName)', '').StartsWith('$(LocalFilter)'))" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackFilterInclude" BeforeTargets="ILRepack" DependsOnTargets="ILRepackFilterExcludeStartsWith">
    <PropertyGroup>
      <ILRepackInclude>;@(ILRepackIncludeExact, ';');</ILRepackInclude>
    </PropertyGroup>
    <ItemGroup>
      <ILRepackCandidate Include="@(ReferenceCopyLocalPaths)" Condition="
        '%(Extension)' == '.dll' And 
        !$([MSBuild]::ValueOrDefault('%(FileName)', '').EndsWith('.resources', StringComparison.OrdinalIgnoreCase)) And
        $(ILRepackInclude.Contains(';%(FileName);'))" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackFilterExclude" BeforeTargets="ILRepack" DependsOnTargets="CoreCompile">
    <PropertyGroup>
      <ILRepackExclude>;@(ILRepackExcludeExact, ';');</ILRepackExclude>
    </PropertyGroup>
    <ItemGroup>
      <ILRepackCandidate Remove="@(ILRepackCandidate)" Condition="$(ILRepackExclude.Contains(';%(FileName);'))" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepack" AfterTargets="CoreCompile" BeforeTargets="CopyFilesToOutputDirectory"
        Inputs="@(IntermediateAssembly -&gt; '%(FullPath)')"
        Outputs="$(IntermediateOutputPath)ilrepack.txt"
        Returns="@(MergedAssemblies)"
        Condition="Exists(@(IntermediateAssembly -&gt; '%(FullPath)')) And '$(ILRepack)' == 'true'">

    <ItemGroup>
      <MergedAssemblies Include="@(ILRepackCandidate -&gt; Distinct())" />
    </ItemGroup>
    <ItemGroup>
      <ReferenceCopyLocalDirs Include="@(ReferenceCopyLocalPaths -&gt; '%(RootDir)%(Directory)')" />
      <ReferenceCopyLocalPaths Remove="@(MergedAssemblies)" />
      <LibDir Include="@(ReferenceCopyLocalDirs -&gt; Distinct())" />
    </ItemGroup>
    <PropertyGroup>
      <AbsoluteAssemblyOriginatorKeyFile Condition="'$(SignAssembly)' == 'true' and '$(AssemblyOriginatorKeyFile)' != ''">$([System.IO.Path]::GetFullPath($([System.IO.Path]::Combine('$(MSBuildProjectDirectory)','$(AssemblyOriginatorKeyFile)'))))</AbsoluteAssemblyOriginatorKeyFile>
      <ILRepackArgs Condition="'$(AbsoluteAssemblyOriginatorKeyFile)' != ''">/keyfile:"$(AbsoluteAssemblyOriginatorKeyFile)" /delaysign</ILRepackArgs>
      <ILRepackArgs>$(ILRepackArgs) /internalize</ILRepackArgs>
      <ILRepackArgs>$(ILRepackArgs) /union</ILRepackArgs>
      <!-- This is needed to merge types with identical names into one, wich happens with IFluentInterface in Merq and Merq.Core (Xamarin.Messaging dependencies) -->
      <ILRepackArgs>$(ILRepackArgs) @(LibDir -&gt; '/lib:"%(Identity)."', ' ')</ILRepackArgs>
      <ILRepackArgs>$(ILRepackArgs) /out:"@(IntermediateAssembly -&gt; '%(FullPath)')"</ILRepackArgs>
      <ILRepackArgs>$(ILRepackArgs) "@(IntermediateAssembly -&gt; '%(FullPath)')"</ILRepackArgs>
      <ILRepackArgs>$(ILRepackArgs) @(MergedAssemblies -&gt; '"%(FullPath)"', ' ')</ILRepackArgs>
      <!--<ILRepackArgs>$(ILRepackArgs) "/lib:$(NetstandardDirectory)"</ILRepackArgs> -->
      <!-- This is needed for ilrepack to find netstandard.dll, which is referenced by the System.Text.Json assembly -->
    </PropertyGroup>
    <Exec Command='ilrepack $(ILRepackArgs)' WorkingDirectory="$(MSBuildProjectDirectory)\$(OutputPath)" StandardErrorImportance="high" IgnoreStandardErrorWarningFormat="true" StandardOutputImportance="low" ConsoleToMSBuild="true" ContinueOnError="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="ILRepackOutput" />
      <Output TaskParameter="ExitCode" PropertyName="ExitCode" />
    </Exec>
    <Message Importance="high" Text="$(ILRepackOutput)" Condition="'$(ExitCode)' != '0'" />
    <Delete Files="$(IntermediateOutputPath)ilrepack.txt" Condition="'$(ExitCode)' != '0'" />
    <Touch AlwaysCreate="true" Files="$(IntermediateOutputPath)ilrepack.txt" Condition="'$(ExitCode)' == '0'" />
    <Error Text="$(ILRepackOutput)" Condition="'$(ExitCode)' != '0' And '$(ContinueOnError)' != 'true'" />
    <ItemGroup>
      <ILRepackCleanup Include="@(MergedAssemblies)" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackPreserveStartsWith" DependsOnTargets="ILRepack"
          Inputs="@(ILRepackPreserveWildcard)" Outputs="|%(ILRepackPreserveWildcard.Identity)|">
    <PropertyGroup>
      <LocalFilter>%(ILRepackPreserveWildcard.Identity)</LocalFilter>
    </PropertyGroup>
    <ItemGroup>
      <ILRepackCleanup Remove="@(ILRepackCleanup)" Condition="$([MSBuild]::ValueOrDefault('%(FileName)', '').StartsWith('$(LocalFilter)'))" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackPreserve" DependsOnTargets="ILRepack">
    <PropertyGroup>
      <ILRepackPreserve>;@(ILRepackPreserveExact, ';');</ILRepackPreserve>
    </PropertyGroup>
    <ItemGroup>
      <ILRepackCleanup Remove="@(ILRepackCleanup)" Condition="$(ILRepackPreserve.Contains(';%(FileName);'))" />
    </ItemGroup>
  </Target>

  <Target Name="ILRepackCleanup" AfterTargets="ILRepack" DependsOnTargets="ILRepackPreserveStartsWith;ILRepackPreserve" Returns="@(ILRepackCleanup)">
    <Delete Files="@(ILRepackCleanup -&gt; '$(MSBuildProjectDirectory)\$(OutputPath)%(Filename)%(Extension)')" 
            Condition="Exists('$(MSBuildProjectDirectory)\$(OutputPath)%(Filename)%(Extension)')" />
  </Target>

</Project>
